<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OpenTalons ‚Äî Captain Claw Web Engine</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Share+Tech+Mono&display=swap" rel="stylesheet"/>
<style>
:root {
  --gold: #F5A623;
  --gold-dim: #A06A10;
  --amber: #FFD17A;
  --navy: #05080F;
  --navy2: #0A1020;
  --navy3: #0F1A30;
  --cyan: #00E5FF;
  --red: #FF4444;
  --green: #39FF14;
  --white: #E8EAF0;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--navy);
  color: var(--white);
  font-family: 'Share Tech Mono', monospace;
  min-height: 100vh;
  overflow-x: hidden;
  cursor: crosshair;
}
body::after {
  content: '';
  position: fixed; inset: 0;
  background: repeating-linear-gradient(0deg, rgba(0,0,0,0.15) 0px, rgba(0,0,0,0.15) 1px, transparent 1px, transparent 3px);
  pointer-events: none;
  z-index: 9999;
  opacity: 0.45;
}
#starfield { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
#app { position: relative; z-index: 1; min-height: 100vh; display: flex; flex-direction: column; }

/* LANDING */
#screen-landing {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; min-height: 100vh; padding: 2rem; text-align: center;
}
.logo-eagle {
  font-size: clamp(4rem, 12vw, 7rem);
  filter: drop-shadow(0 0 28px var(--gold));
  animation: eaglefloat 4s ease-in-out infinite; line-height: 1; margin-bottom: 0.4rem;
}
@keyframes eaglefloat {
  0%,100% { transform: translateY(0) rotate(-3deg); }
  50% { transform: translateY(-12px) rotate(3deg); }
}
.logo-title {
  font-family: 'Press Start 2P', monospace;
  font-size: clamp(1.6rem, 5vw, 3.2rem);
  color: var(--gold);
  text-shadow: 0 0 10px var(--gold), 0 0 30px var(--gold-dim), 4px 4px 0 #000;
  margin-bottom: 0.4rem;
  animation: flicker 9s infinite;
}
@keyframes flicker { 0%,94%,100%{opacity:1} 95%,97%{opacity:.5} 96%{opacity:.2} }
.logo-sub { font-size:.8rem; color:var(--amber); letter-spacing:.25em; text-transform:uppercase; margin-bottom:.3rem; opacity:.8; }
.logo-ver { font-size:.55rem; color:var(--gold-dim); letter-spacing:.15em; margin-bottom:3rem; }
.launch-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 1.4rem;
  max-width: 740px; width: 100%; margin-bottom: 2rem;
}
@media(max-width:560px){ .launch-grid{grid-template-columns:1fr;} }
.lcard {
  background: linear-gradient(135deg, var(--navy3), var(--navy2));
  border: 1px solid var(--gold-dim);
  padding: 2rem 1.5rem; cursor: pointer;
  transition: all .18s ease; position: relative; overflow: hidden; text-align: left;
}
.lcard:hover {
  border-color: var(--gold); transform: translateY(-4px);
  box-shadow: 0 8px 36px rgba(245,166,35,.2), 0 0 0 1px var(--gold);
}
.lcard-icon { font-size:2rem; display:block; margin-bottom:.7rem; }
.lcard-badge {
  position:absolute; top:.6rem; right:.6rem;
  font-size:.45rem; font-family:'Press Start 2P',monospace;
  padding:.2rem .35rem; border:1px solid var(--green); color:var(--green);
}
.lcard-title { font-family:'Press Start 2P',monospace; font-size:.7rem; color:var(--gold); margin-bottom:.5rem; line-height:1.6; }
.lcard-desc { font-size:.68rem; color:#7788AA; line-height:1.7; }
.footer-note { font-size:.55rem; color:#2A3A5A; letter-spacing:.12em; line-height:2; }
.footer-note a { color:var(--gold-dim); text-decoration:none; }
.footer-note a:hover { color:var(--gold); }

/* TOP BAR */
.top-bar {
  display:flex; align-items:center; gap:1rem; padding:.9rem 1.4rem;
  border-bottom:1px solid #1A2540; background:rgba(5,8,15,.92);
  backdrop-filter:blur(8px); position:sticky; top:0; z-index:100;
}
.top-bar-logo { font-family:'Press Start 2P',monospace; font-size:.6rem; color:var(--gold); }
.top-bar-logo span { font-size:.9rem; margin-right:.35rem; }
.btn-back {
  margin-left:auto; background:none; border:1px solid #2A3A5A;
  color:#5577AA; font-family:'Share Tech Mono',monospace; font-size:.65rem;
  padding:.35rem .8rem; cursor:pointer; letter-spacing:.1em; transition:all .15s;
}
.btn-back:hover { border-color:var(--gold-dim); color:var(--gold); }

/* DEMO */
#screen-demo { display:none; flex-direction:column; min-height:100vh; }
#demo-wrapper {
  flex:1; display:flex; flex-direction:column;
  align-items:center; justify-content:center; padding:1.2rem; gap:.8rem;
}
.demo-head { text-align:center; }
.demo-title { font-family:'Press Start 2P',monospace; font-size:.7rem; color:var(--amber); margin-bottom:.3rem; }
.demo-sub { font-size:.6rem; color:#445577; letter-spacing:.12em; }
#game-canvas {
  border:2px solid var(--gold-dim);
  box-shadow:0 0 0 1px #0A1020, 0 0 36px rgba(245,166,35,.15);
  image-rendering:pixelated; display:block; max-width:100%;
}
.demo-controls { display:flex; gap:1.8rem; flex-wrap:wrap; justify-content:center; }
.ctrl { font-size:.6rem; color:#3A4A6A; letter-spacing:.08em; }
.key {
  display:inline-block; background:#0F1A30; border:1px solid #2A3A5A;
  color:var(--amber); font-family:'Press Start 2P',monospace;
  font-size:.4rem; padding:.18rem .35rem; margin-right:.25rem;
}
.demo-stats { display:flex; gap:1.8rem; font-size:.58rem; color:#2A3A5A; }
#demo-fps { font-size:.6rem; color:var(--green); margin-left:1rem; }

/* UPLOAD */
#screen-upload { display:none; flex-direction:column; align-items:center; min-height:100vh; padding:1.5rem; }
.up-title { font-family:'Press Start 2P',monospace; font-size:.9rem; color:var(--gold); text-align:center; margin:1.5rem 0 .4rem; text-shadow:0 0 18px var(--gold-dim); }
.up-sub { font-size:.65rem; color:#445566; text-align:center; letter-spacing:.1em; margin-bottom:1.5rem; }

#drop-zone {
  width:100%; max-width:620px; border:2px dashed var(--gold-dim);
  padding:3.5rem 1.5rem; text-align:center; cursor:pointer;
  transition:all .2s; background:rgba(10,16,32,.6); margin-bottom:1.2rem;
}
#drop-zone:hover, #drop-zone.drag-over {
  border-color:var(--gold); background:rgba(245,166,35,.04);
  box-shadow:0 0 28px rgba(245,166,35,.1);
}
.drop-icon { font-size:2.8rem; margin-bottom:.8rem; display:block; }
.drop-title { font-family:'Press Start 2P',monospace; font-size:.6rem; color:var(--amber); margin-bottom:.4rem; line-height:1.8; }
.drop-hint { font-size:.62rem; color:#334455; letter-spacing:.08em; }
.btn-browse {
  background:var(--navy3); border:1px solid var(--gold-dim); color:var(--gold);
  font-family:'Share Tech Mono',monospace; font-size:.7rem;
  padding:.6rem 1.3rem; cursor:pointer; letter-spacing:.12em; transition:all .15s; margin-top:1.2rem; display:inline-block;
}
.btn-browse:hover { background:rgba(245,166,35,.08); border-color:var(--gold); box-shadow:0 0 18px rgba(245,166,35,.12); }
#rez-input { display:none; }

/* Progress */
.parse-progress { width:100%; max-width:620px; display:none; }
.prog-label { font-size:.6rem; color:var(--amber); letter-spacing:.12em; margin-bottom:.4rem; display:flex; justify-content:space-between; }
.prog-track { height:4px; background:#0A1020; border:1px solid #1A2540; overflow:hidden; }
.prog-fill { height:100%; background:linear-gradient(90deg,var(--gold-dim),var(--gold)); transition:width .2s; width:0%; box-shadow:0 0 6px var(--gold); }

/* REZ Tree */
#rez-result { width:100%; max-width:900px; display:none; margin-top:.5rem; }
.rez-toolbar {
  display:flex; align-items:center; gap:1rem; padding:.7rem .9rem;
  background:var(--navy3); border:1px solid #1A2540; border-bottom:none; flex-wrap:wrap;
}
.rez-name { font-family:'Press Start 2P',monospace; font-size:.55rem; color:var(--gold); }
.rez-stats { font-size:.62rem; color:#445566; margin-left:auto; }
.rez-search {
  background:var(--navy); border:1px solid #2A3A5A; color:var(--white);
  font-family:'Share Tech Mono',monospace; font-size:.65rem; padding:.28rem .6rem; width:190px; outline:none;
}
.rez-search:focus { border-color:var(--gold-dim); }
.rez-search::placeholder { color:#2A3A5A; }
#rez-tree {
  background:rgba(5,8,15,.96); border:1px solid #1A2540; max-height:400px; overflow-y:auto; font-size:.66rem;
}
#rez-tree::-webkit-scrollbar { width:5px; }
#rez-tree::-webkit-scrollbar-track { background:var(--navy); }
#rez-tree::-webkit-scrollbar-thumb { background:#2A3A5A; }
.tdir-header {
  display:flex; align-items:center; gap:.45rem; padding:.32rem .8rem;
  cursor:pointer; color:var(--amber); transition:background .1s; border-bottom:1px solid rgba(26,37,64,.4);
}
.tdir-header:hover { background:rgba(245,166,35,.05); }
.tdir-icon { font-size:.65rem; transition:transform .15s; }
.tdir-icon.open { transform:rotate(90deg); }
.tdir-count { margin-left:auto; color:#2A3A5A; font-size:.55rem; }
.tchildren { display:none; }
.tchildren.open { display:block; }
.tfile {
  display:flex; align-items:center; gap:.45rem; padding:.25rem .8rem;
  color:#5566AA; cursor:pointer; border-bottom:1px solid rgba(26,37,64,.25); transition:all .1s;
}
.tfile:hover { background:rgba(0,229,255,.04); color:var(--cyan); }
.fext {
  font-size:.5rem; padding:.08rem .28rem; border:1px solid; font-family:'Press Start 2P',monospace; min-width:30px; text-align:center;
}
.eWAV,.eMID { border-color:#FF6B35; color:#FF6B35; }
.ePID,.ePCX { border-color:var(--cyan); color:var(--cyan); }
.eWWD { border-color:var(--gold-dim); color:var(--gold); }
.ePAL { border-color:#AA66FF; color:#AA66FF; }
.eOTH { border-color:#2A3A5A; color:#2A3A5A; }
.fname { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.fsize { color:#223344; font-size:.58rem; white-space:nowrap; }
.rez-footer {
  display:flex; align-items:center; gap:1rem; padding:.8rem .9rem;
  background:var(--navy3); border:1px solid #1A2540; border-top:1px solid var(--gold-dim); flex-wrap:wrap;
}
.rez-ok { font-size:.62rem; color:var(--green); }
.btn-launch {
  margin-left:auto; background:var(--gold); border:none; color:#000;
  font-family:'Press Start 2P',monospace; font-size:.5rem; padding:.65rem 1.2rem;
  cursor:pointer; letter-spacing:.1em; transition:all .15s;
}
.btn-launch:hover { background:var(--amber); box-shadow:0 0 18px rgba(245,166,35,.4); transform:scale(1.02); }

/* Toast */
#toast {
  position:fixed; bottom:2rem; left:50%; transform:translateX(-50%) translateY(120%);
  background:#1A0A0A; border:1px solid var(--red); color:var(--red);
  font-size:.62rem; padding:.65rem 1.4rem; z-index:9998;
  transition:transform .3s; letter-spacing:.08em; max-width:90vw; text-align:center;
}
#toast.show { transform:translateX(-50%) translateY(0); }
#toast.info { border-color:var(--green); color:var(--green); background:#0A1A0A; }

/* Anim */
@keyframes fadeUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
.fu { animation:fadeUp .45s ease forwards; opacity:0; }
.d1{animation-delay:.08s} .d2{animation-delay:.18s} .d3{animation-delay:.3s}
.d4{animation-delay:.45s} .d5{animation-delay:.6s}

::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--navy)}
::-webkit-scrollbar-thumb{background:#2A3A5A}
</style>
</head>
<body>

<canvas id="starfield"></canvas>

<div id="app">

  <!-- ‚ïê‚ïê LANDING ‚ïê‚ïê -->
  <div id="screen-landing">
    <div class="logo-eagle fu">ü¶Ö</div>
    <h1 class="logo-title fu d1">OpenTalons</h1>
    <p class="logo-sub fu d2">Captain Claw Web Engine</p>
    <p class="logo-ver fu d2">v0.1.0 ‚Äî MIT License ‚Äî TypeScript + PixiJS + bitECS</p>
    <div class="launch-grid fu d3">
      <div class="lcard" onclick="showDemo()">
        <span class="lcard-icon">üéÆ</span>
        <div class="lcard-badge">LIVE</div>
        <div class="lcard-title">DEMO MODE</div>
        <div class="lcard-desc">Play a fully interactive tech demo right now. No files needed. Physics engine, ECS, parallax, enemies, and collectibles in action.</div>
      </div>
      <div class="lcard" onclick="showUpload()">
        <span class="lcard-icon">üì¶</span>
        <div class="lcard-badge">BETA</div>
        <div class="lcard-title">LOAD YOUR GAME</div>
        <div class="lcard-desc">Own Captain Claw (1997)? Drop your CLAW.REZ file to browse every asset, inspect sprites, levels and sounds. All in-browser.</div>
      </div>
    </div>
    <p class="footer-note fu d5">
      Open source ¬∑ MIT License ¬∑ <a href="https://github.com/opentalons/opentalons" target="_blank">github.com/opentalons</a><br>
      Not affiliated with Monolith Productions or Warner Bros. ¬∑ Requires legal copy of Captain Claw (1997)
    </p>
  </div>

  <!-- ‚ïê‚ïê DEMO ‚ïê‚ïê -->
  <div id="screen-demo">
    <div class="top-bar">
      <div class="top-bar-logo"><span>ü¶Ö</span>OpenTalons ‚Äî Tech Demo</div>
      <span id="demo-fps"></span>
      <button class="btn-back" onclick="showLanding()">‚Üê BACK</button>
    </div>
    <div id="demo-wrapper">
      <div class="demo-head">
        <div class="demo-title">THE DOCKS ‚Äî TECH DEMO</div>
        <div class="demo-sub">Fixed-timestep physics ¬∑ ECS entities ¬∑ Parallax ¬∑ Tile collision</div>
      </div>
      <canvas id="game-canvas" width="800" height="450"></canvas>
      <div class="demo-controls">
        <span class="ctrl"><span class="key">‚Üê</span><span class="key">‚Üí</span> MOVE</span>
        <span class="ctrl"><span class="key">SPACE</span> JUMP</span>
        <span class="ctrl"><span class="key">‚Üë</span> CLIMB</span>
        <span class="ctrl"><span class="key">Z</span> ATTACK</span>
      </div>
      <div class="demo-stats">
        <span>ENGINE: <span style="color:var(--amber)">OpenTalons v0.1</span></span>
        <span>TICK: <span style="color:var(--amber)">60Hz fixed</span></span>
        <span id="ent-count">ENTITIES: <span style="color:var(--amber)">0</span></span>
        <span id="score-display">SCORE: <span style="color:var(--amber)">0</span></span>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê UPLOAD ‚ïê‚ïê -->
  <div id="screen-upload">
    <div class="top-bar">
      <div class="top-bar-logo"><span>ü¶Ö</span>OpenTalons ‚Äî Asset Loader</div>
      <button class="btn-back" onclick="showLanding()">‚Üê BACK</button>
    </div>
    <h2 class="up-title">LOAD GAME ASSETS</h2>
    <p class="up-sub">DROP YOUR CLAW.REZ ‚Äî ALL PROCESSING HAPPENS IN YOUR BROWSER. NO UPLOAD.</p>
    <div id="drop-zone" onclick="document.getElementById('rez-input').click()">
      <span class="drop-icon">üì¶</span>
      <div class="drop-title">DROP CLAW.REZ HERE<br>OR CLICK TO BROWSE</div>
      <div class="drop-hint">Supports: CLAW.REZ ¬∑ levelXX.REZ ¬∑ any Monolith RIOT engine archive</div>
      <button class="btn-browse" onclick="event.stopPropagation();document.getElementById('rez-input').click()">BROWSE FILES</button>
    </div>
    <input type="file" id="rez-input" accept=".rez,.REZ"/>
    <div class="parse-progress" id="parse-prog">
      <div class="prog-label"><span id="prog-txt">PARSING...</span><span id="prog-pct">0%</span></div>
      <div class="prog-track"><div class="prog-fill" id="prog-fill"></div></div>
    </div>
    <div id="rez-result">
      <div class="rez-toolbar">
        <span class="rez-name" id="rez-fname">CLAW.REZ</span>
        <input class="rez-search" id="rez-search" placeholder="SEARCH FILES..." oninput="filterTree(this.value)"/>
        <span class="rez-stats" id="rez-stats"></span>
      </div>
      <div id="rez-tree"></div>
      <div class="rez-footer">
        <span class="rez-ok" id="rez-ok">‚úì ARCHIVE READY</span>
        <button class="btn-launch" onclick="launchFromRez()">‚ñ∂ LAUNCH ENGINE</button>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STARFIELD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){
  const c=document.getElementById('starfield'),ctx=c.getContext('2d');
  let stars=[];
  function resize(){ c.width=window.innerWidth; c.height=window.innerHeight; }
  function init(){ stars=Array.from({length:200},()=>({
    x:Math.random()*c.width, y:Math.random()*c.height,
    r:Math.random()*1.2+.2, speed:Math.random()*.35+.04,
    a:Math.random()*.5+.1, t:Math.random()*Math.PI*2
  })); }
  function draw(){
    ctx.clearRect(0,0,c.width,c.height);
    for(const s of stars){
      s.t+=.018; s.y+=s.speed;
      if(s.y>c.height){s.y=0;s.x=Math.random()*c.width;}
      const a=s.a*(.7+.3*Math.sin(s.t));
      ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      ctx.fillStyle=`rgba(200,210,255,${a})`; ctx.fill();
    }
    requestAnimationFrame(draw);
  }
  resize(); init(); draw();
  window.addEventListener('resize',()=>{resize();init();});
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let demoStarted=false;
function showLanding(){
  document.getElementById('screen-landing').style.display='flex';
  document.getElementById('screen-demo').style.display='none';
  document.getElementById('screen-upload').style.display='none';
  demoActive=false;
}
function showDemo(){
  document.getElementById('screen-landing').style.display='none';
  document.getElementById('screen-demo').style.display='flex';
  document.getElementById('screen-upload').style.display='none';
  if(!demoStarted){demoStarted=true;startDemo();}
  demoActive=true;
}
function showUpload(){
  document.getElementById('screen-landing').style.display='none';
  document.getElementById('screen-demo').style.display='none';
  document.getElementById('screen-upload').style.display='flex';
  setupDrop();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg,type='err'){
  const el=document.getElementById('toast');
  el.textContent=msg;
  el.className=type==='info'?'show info':'show';
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>el.className='',3600);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEMO ENGINE
//  Authentic Captain Claw physics:
//  GRAVITY=0.35, JUMP=-9.5, WALK=3.0
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let demoActive=false;

function startDemo(){
  const canvas=document.getElementById('game-canvas');
  const ctx=canvas.getContext('2d');
  const W=800,H=450;

  // Physics constants matching PhysicsSystem.ts
  const GRAVITY=0.35, MAX_FALL=16, JUMP=-9.5, WALK=3.0, TILE=40;

  const keys={};
  window.addEventListener('keydown',e=>{keys[e.code]=true; if(['Space','ArrowUp','ArrowDown'].includes(e.code))e.preventDefault();});
  window.addEventListener('keyup',  e=>keys[e.code]=false);

  // Tilemap  0=empty 1=solid 2=platform 3=ladder
  const MAP=[
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,0,0,0,0,0],
    [0,0,0,0,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,3,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  ];

  function tileAt(col,row){
    if(col<0||col>=30||row<0||row>=12)return 1;
    return MAP[row]?.[col]??0;
  }
  function solid(px,py){ const t=tileAt(Math.floor(px/TILE),Math.floor(py/TILE)); return t===1; }
  function platform(px,py){ return tileAt(Math.floor(px/TILE),Math.floor(py/TILE))===2; }
  function ladder(px,py){ return tileAt(Math.floor(px/TILE),Math.floor(py/TILE))===3; }

  // Player entity
  const P={
    x:80,y:300,px:80,py:300,vx:0,vy:0,
    w:26,h:38,onGround:false,onLadder:false,
    face:1,atk:0,frame:0,ft:0,score:0,hp:100
  };

  // Enemies
  const enemies=[
    {x:500,y:320,vx:-1.2,w:28,h:36,hp:3,max_hp:3,patrol:[420,590],col:'#CC2222',ft:0},
    {x:730,y:320,vx:1.0, w:28,h:36,hp:3,max_hp:3,patrol:[660,820],col:'#CC2222',ft:0},
    {x:340,y:200,vx:0.9, w:26,h:34,hp:2,max_hp:2,patrol:[275,430],col:'#9922AA',ft:0},
  ];

  // Coins
  const coins=[[5,8],[6,8],[12,1],[13,1],[14,1],[21,2],[22,3],[23,3],[25,7]].map(([c,r],i)=>({
    x:c*TILE+TILE/2, y:r*TILE+TILE/2, collected:false, b:Math.random()*Math.PI*2
  }));

  // Parallax clouds
  const clouds=Array.from({length:9},(_,i)=>({
    x:i*160+Math.random()*50, y:25+Math.random()*90,
    w:70+Math.random()*70, h:20+Math.random()*20
  }));

  let camX=0;

  function resolveEntity(e){
    const hw=e.w/2,hh=e.h/2;
    if(!e.onLadder){ e.vy+=GRAVITY; if(e.vy>MAX_FALL)e.vy=MAX_FALL; }
    e.px=e.x; e.py=e.y;
    // Horizontal
    const nx=e.x+e.vx;
    const ty1=e.y-hh+4,ty2=e.y+hh-4;
    const lx=e.vx>0?nx+hw:nx-hw;
    if(solid(lx,ty1)||solid(lx,ty2)){
      const col=Math.floor(lx/TILE);
      e.x=e.vx>0?col*TILE-hw:(col+1)*TILE+hw;
      e.vx=e.vx>0?-Math.abs(e.vx||1):Math.abs(e.vx||1); // enemies bounce
    } else { e.x=nx; }
    // Vertical
    const ny=e.y+e.vy;
    const lx1=e.x-hw+4,lx2=e.x+hw-4;
    if(e.vy>0&&(solid(lx1,ny+hh)||solid(lx2,ny+hh)||platform(lx1,ny+hh)||platform(lx2,ny+hh))){
      const row=Math.floor((ny+hh)/TILE);
      e.y=row*TILE-hh; e.vy=0; e.onGround=true;
    } else if(e.vy<0&&(solid(lx1,ny-hh)||solid(lx2,ny-hh))){
      const row=Math.floor((ny-hh)/TILE);
      e.y=(row+1)*TILE+hh; e.vy=0;
    } else { e.y=ny; e.onGround=false; }
  }

  function logicTick(){
    // Player
    const ml=keys['ArrowLeft']||keys['KeyA'];
    const mr=keys['ArrowRight']||keys['KeyD'];
    const ju=keys['Space']||keys['ArrowUp']||keys['KeyW'];
    const cl=keys['ArrowUp']||keys['KeyW'];
    const cd=keys['ArrowDown']||keys['KeyS'];
    const at=keys['KeyZ']||keys['KeyX'];

    P.onLadder=ladder(P.x,P.y);
    if(ml){P.vx=-WALK;P.face=-1;}
    else if(mr){P.vx=WALK;P.face=1;}
    else{P.vx*=.78;}

    if(P.onLadder){P.vy=0;if(cl)P.vy=-2.5;if(cd)P.vy=2.5;}
    else if(ju&&P.onGround){P.vy=JUMP;P.onGround=false;}

    if(at&&P.atk<=0)P.atk=18;
    if(P.atk>0)P.atk--;
    P.ft++; if(P.ft%8===0)P.frame=(P.frame+1)%4;
    resolveEntity(P);

    // Camera
    camX+=(P.x-W/2-camX)*.1;
    camX=Math.max(0,Math.min(30*TILE-W,camX));

    // Enemies
    for(const e of enemies){
      if(e.hp<=0)continue;
      if(e.x<e.patrol[0])e.vx=Math.abs(e.vx);
      if(e.x>e.patrol[1])e.vx=-Math.abs(e.vx);
      e.ft++; if(e.ft%10===0)e.frame=(e.frame||0)+1;
      resolveEntity(e);
      // Player claw hits
      if(P.atk>10){
        const ax=P.x+P.face*44;
        if(Math.abs(ax-e.x)<32&&Math.abs(P.y-e.y)<30){
          e.hp--; e.vx=P.face*5; e.vy=-3.5;
          if(e.hp<=0)P.score+=100;
        }
      }
    }

    // Coins
    for(const c of coins){
      if(c.collected)continue;
      c.b+=.06;
      if(Math.abs(P.x-c.x)<22&&Math.abs(P.y-c.y)<22){c.collected=true;P.score+=10;}
    }

    const alive=1+enemies.filter(e=>e.hp>0).length+coins.filter(c=>!c.collected).length;
    document.getElementById('ent-count').innerHTML=`ENTITIES: <span style="color:var(--amber)">${alive}</span>`;
    document.getElementById('score-display').innerHTML=`SCORE: <span style="color:var(--amber)">${P.score}</span>`;
  }

  function drawTile(col,row,t){
    const sx=col*TILE-camX,sy=row*TILE;
    if(sx<-TILE||sx>W)return;
    if(t===1){
      ctx.fillStyle='#1A2840'; ctx.fillRect(sx,sy,TILE,TILE);
      ctx.fillStyle='#233050'; ctx.fillRect(sx+1,sy+1,TILE-2,14);
      ctx.fillStyle='#2C3F65'; ctx.fillRect(sx+2,sy+2,TILE-4,4);
      ctx.strokeStyle='#0F1A2E'; ctx.lineWidth=1; ctx.strokeRect(sx+.5,sy+.5,TILE-1,TILE-1);
    } else if(t===2){
      ctx.fillStyle='#274030'; ctx.fillRect(sx,sy,TILE,10);
      ctx.fillStyle='#375840'; ctx.fillRect(sx+1,sy+1,TILE-2,5);
      ctx.strokeStyle='#182818'; ctx.lineWidth=1; ctx.strokeRect(sx+.5,sy+.5,TILE-1,9);
    } else if(t===3){
      ctx.fillStyle='#4A3520';
      ctx.fillRect(sx+11,sy,5,TILE); ctx.fillRect(sx+TILE-16,sy,5,TILE);
      for(let rg=2;rg<TILE;rg+=10){ ctx.fillStyle='#6A5030'; ctx.fillRect(sx+11,sy+rg,TILE-22,4); }
    }
  }

  function drawPlayer(al){
    const x=P.px+(P.x-P.px)*al-camX;
    const y=P.py+(P.y-P.py)*al;
    const hw=P.w/2,hh=P.h/2;
    ctx.save(); ctx.translate(x,y); ctx.scale(P.face,1);
    // Cape
    ctx.fillStyle='#BB1111'; ctx.fillRect(-hw-5,- hh+6,7,P.h-10);
    // Body
    ctx.fillStyle='#E8941C'; ctx.fillRect(-hw,-hh,P.w,P.h);
    // Belt
    ctx.fillStyle='#8B5A00'; ctx.fillRect(-hw,2,P.w,5);
    // Head
    ctx.fillStyle='#F0C080'; ctx.fillRect(-8,-hh-12,16,13);
    // Hat
    ctx.fillStyle='#1A1A1A'; ctx.fillRect(-9,-hh-16,18,6); ctx.fillRect(-6,-hh-23,12,9);
    ctx.fillStyle='#2A2A2A'; ctx.fillRect(-10,-hh-17,3,7);
    // Eyes
    ctx.fillStyle='#000'; ctx.fillRect(2,-hh-10,3,3);
    ctx.fillStyle='#FFF'; ctx.fillRect(3,-hh-10,1,2);
    // Boots
    ctx.fillStyle='#5A3311'; ctx.fillRect(-hw,hh-8,12,8); ctx.fillRect(hw-12,hh-8,14,8);
    // Attack claw
    if(P.atk>0){
      const reach=14+(18-P.atk)*2.2;
      ctx.strokeStyle='#FFD17A'; ctx.lineWidth=2.5;
      ctx.beginPath(); ctx.moveTo(hw,-2); ctx.lineTo(hw+reach,-2); ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(hw+reach,-8); ctx.lineTo(hw+reach+9,-2);
      ctx.moveTo(hw+reach,4);  ctx.lineTo(hw+reach+9,-2);
      ctx.stroke();
    }
    ctx.restore();
    // HP bar above
    const barW=36;
    ctx.fillStyle='rgba(0,0,0,.55)'; ctx.fillRect(x-barW/2,y-hh-20,barW,5);
    ctx.fillStyle='#33CC22'; ctx.fillRect(x-barW/2,y-hh-20,barW*(P.hp/100),5);
  }

  function drawEnemy(e,al){
    if(e.hp<=0)return;
    const x=e.x-camX,y=e.y;
    const hw=e.w/2,hh=e.h/2;
    const dir=e.vx>=0?1:-1;
    ctx.save(); ctx.translate(x,y); ctx.scale(dir,1);
    ctx.fillStyle=e.col; ctx.fillRect(-hw,-hh,e.w,e.h);
    ctx.fillStyle='#F0C080'; ctx.fillRect(-7,-hh-10,14,11);
    ctx.fillStyle='#992200'; ctx.fillRect(-8,-hh-14,16,7);
    ctx.fillStyle='#FFE'; ctx.fillRect(2,-hh-8,3,3);
    // HP bar
    ctx.fillStyle='#2A0000'; ctx.fillRect(-hw,hh+3,e.w,3);
    ctx.fillStyle='#FF2222'; ctx.fillRect(-hw,hh+3,e.w*(e.hp/e.max_hp),3);
    ctx.restore();
  }

  function render(al){
    ctx.clearRect(0,0,W,H);
    // Sky
    const sky=ctx.createLinearGradient(0,0,0,H);
    sky.addColorStop(0,'#04080F'); sky.addColorStop(1,'#091525');
    ctx.fillStyle=sky; ctx.fillRect(0,0,W,H);
    // Stars in BG
    for(let i=0;i<40;i++){
      const sx=(i*173+100)%W, sy=(i*97+50)%(H*.6);
      ctx.fillStyle=`rgba(200,220,255,${.15+.1*Math.sin(Date.now()*.001+i)})`;
      ctx.fillRect(sx,sy,1,1);
    }
    // Mountains parallax 0.15
    const mo=camX*.15;
    ctx.fillStyle='#0A1525';
    for(let i=0;i<7;i++){ const mx=i*190-mo%190;
      ctx.beginPath();ctx.moveTo(mx,H);ctx.lineTo(mx+95,170);ctx.lineTo(mx+190,H);ctx.closePath();ctx.fill(); }
    // Clouds parallax 0.28
    for(const cl of clouds){
      const cx=cl.x-camX*.28;
      ctx.fillStyle='rgba(25,45,80,.55)';
      ctx.beginPath();ctx.ellipse(cx,cl.y,cl.w/2,cl.h/2,0,0,Math.PI*2);ctx.fill();
    }
    // Tiles
    for(let r=0;r<12;r++)for(let c=0;c<30;c++){const t=MAP[r][c];if(t>0)drawTile(c,r,t);}
    // Coins
    for(const c of coins){
      if(c.collected)continue;
      const cx=c.x-camX, cy=c.y+Math.sin(c.b)*4, cr=6;
      ctx.beginPath();ctx.arc(cx,cy,cr,0,Math.PI*2);
      const g=ctx.createRadialGradient(cx-2,cy-2,1,cx,cy,cr);
      g.addColorStop(0,'#FFE060');g.addColorStop(1,'#AA7700');
      ctx.fillStyle=g;ctx.fill();
      ctx.strokeStyle='#FFD700';ctx.lineWidth=1;ctx.stroke();
      ctx.fillStyle='#7A5500';ctx.font='bold 7px monospace';
      ctx.textAlign='center';ctx.fillText('$',cx,cy+3);ctx.textAlign='left';
    }
    // Enemies
    for(const e of enemies)drawEnemy(e,al);
    // Player
    drawPlayer(al);
    // HUD
    ctx.fillStyle='rgba(0,0,0,.55)';ctx.fillRect(8,8,110,14);
    ctx.fillStyle=P.hp>50?'#22BB22':P.hp>25?'#BBAA00':'#CC2200';
    ctx.fillRect(9,9,P.hp*1.1,12);
    ctx.strokeStyle='#5A3311';ctx.lineWidth=1;ctx.strokeRect(8.5,8.5,111,13);
    ctx.fillStyle='#FFE0A0';ctx.font='7px "Share Tech Mono"';ctx.fillText(`HP ${P.hp}`,13,20);
    ctx.fillStyle='#F5A623';ctx.font='bold 10px "Share Tech Mono"';
    ctx.fillText(`‚ô¶ ${P.score}`,W-100,22);
    // FPS
    ctx.fillStyle='rgba(57,255,20,.5)';ctx.font='7px monospace';ctx.fillText(fps+' FPS',W-44,H-7);
  }

  let acc=0,last=performance.now(),fps=0,fpsT=0,fpsC=0;
  const STEP=1000/60;

  function loop(now){
    if(!demoActive){last=now;requestAnimationFrame(loop);return;}
    let ft=now-last;last=now;
    if(ft>200)ft=200;
    acc+=ft;
    while(acc>=STEP){logicTick();acc-=STEP;}
    render(acc/STEP);
    fpsC++;fpsT+=ft;
    if(fpsT>=1000){fps=fpsC;fpsC=0;fpsT=0;document.getElementById('demo-fps').textContent=fps+' FPS';}
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REZ PARSER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let rezData=null;

function setupDrop(){
  const zone=document.getElementById('drop-zone');
  zone.addEventListener('dragover',e=>{e.preventDefault();zone.classList.add('drag-over');});
  zone.addEventListener('dragleave',()=>zone.classList.remove('drag-over'));
  zone.addEventListener('drop',e=>{e.preventDefault();zone.classList.remove('drag-over');const f=e.dataTransfer.files[0];if(f)loadRez(f);});
  document.getElementById('rez-input').onchange=e=>{const f=e.target.files[0];if(f)loadRez(f);};
}

async function loadRez(file){
  if(!file.name.toLowerCase().endsWith('.rez')){toast('‚ö† Please select a .REZ file');return;}
  const prog=document.getElementById('parse-prog');
  const fill=document.getElementById('prog-fill');
  const pct=document.getElementById('prog-pct');
  const ptxt=document.getElementById('prog-txt');
  prog.style.display='block';
  document.getElementById('rez-result').style.display='none';

  const steps=[[10,'READING FILE...'],[30,'VALIDATING HEADER...'],[55,'WALKING DIRECTORY TREE...'],[80,'INDEXING ENTRIES...'],[100,'DONE']];
  for(let i=0;i<steps.length-1;i++){
    await new Promise(r=>setTimeout(r,160));
    fill.style.width=steps[i][0]+'%';pct.textContent=steps[i][0]+'%';ptxt.textContent=steps[i][1];
  }
  const buf=await file.arrayBuffer();
  try{
    rezData=parseRez(buf,file.name);
    fill.style.width='100%';pct.textContent='100%';ptxt.textContent='DONE';
    setTimeout(()=>{prog.style.display='none';renderTree(rezData,file.name);},250);
  }catch(e){toast('‚ö† '+e.message);prog.style.display='none';}
}

function parseRez(buf,fname){
  const raw=new Uint8Array(buf),view=new DataView(buf);
  const magic=String.fromCharCode(raw[0],raw[1],raw[2]);
  if(magic.toUpperCase()!=='REZ')throw new Error(`Bad magic "${magic}" ‚Äî is this a .REZ file?`);
  const version=view.getUint32(4,true);
  const rootOff=view.getUint32(8,true);
  const root={name:'',path:'/',files:[],dirs:[]};
  let total=0;
  function rs(off,len){let e=off;const l=Math.min(off+len,raw.length);while(e<l&&raw[e]!==0)e++;return String.fromCharCode(...raw.slice(off,e));}
  function walk(dir,off){
    while(off!==0&&off<buf.byteLength){
      if(off+0x14>buf.byteLength)break;
      const next=view.getUint32(off,true);
      const doff=view.getUint32(off+4,true);
      const dsz= view.getUint32(off+8,true);
      const ts=  view.getUint32(off+12,true);
      const flags=raw[off+16],nlen=raw[off+17],elen=raw[off+18];
      const name=rs(off+0x14,nlen);
      const ext=elen>0?rs(off+0x14+nlen,elen):'';
      const cp=dir.path==='/'?'/'+name:dir.path+'/'+name;
      if(flags===1){const ch={name,path:cp,files:[],dirs:[]};dir.dirs.push(ch);if(doff!==0)walk(ch,doff);}
      else{total++;dir.files.push({name,path:cp,ext:ext.toUpperCase(),offset:doff,size:dsz});}
      off=next;
    }
  }
  walk(root,rootOff);
  return{version,root,total,fname};
}

function countAll(dir){let n=dir.files.length;for(const d of dir.dirs)n+=countAll(d);return n;}

function renderTree(archive,fname){
  document.getElementById('rez-fname').textContent=fname.toUpperCase();
  document.getElementById('rez-stats').textContent=`v${archive.version} ¬∑ ${archive.total.toLocaleString()} files`;
  document.getElementById('rez-ok').textContent=`‚úì ${archive.total.toLocaleString()} FILES INDEXED ¬∑ READY`;
  const tree=document.getElementById('rez-tree');
  tree.innerHTML=buildHTML(archive.root,0);
  bindClicks(tree);
  document.getElementById('rez-result').style.display='block';
}

function buildHTML(dir,depth){
  let h='';
  for(const d of dir.dirs){
    const cnt=countAll(d);
    h+=`<div>
      <div class="tdir-header" style="padding-left:${.8+depth*1.1}rem">
        <span class="tdir-icon">‚ñ∂</span>
        <span>üìÅ ${d.name}</span>
        <span class="tdir-count">${cnt}</span>
      </div>
      <div class="tchildren">${buildHTML(d,depth+1)}</div>
    </div>`;
  }
  for(const f of dir.files){
    const kb=f.size>1024?(f.size/1024).toFixed(1)+' KB':f.size+' B';
    const ec=['WAV','MID'].includes(f.ext)?'eWAV':['PID','PCX'].includes(f.ext)?'ePID':f.ext==='WWD'?'eWWD':f.ext==='PAL'?'ePAL':'eOTH';
    h+=`<div class="tfile" style="padding-left:${2+depth*1.1}rem">
      <span class="fext ${ec}">${f.ext||'?'}</span>
      <span class="fname">${f.name}</span>
      <span class="fsize">${kb}</span>
    </div>`;
  }
  return h;
}

function bindClicks(tree){
  tree.querySelectorAll('.tdir-header').forEach(el=>{
    el.onclick=()=>{
      const ch=el.nextElementSibling;
      const ic=el.querySelector('.tdir-icon');
      const open=ch.classList.toggle('open');
      ic.classList.toggle('open',open);
    };
  });
}

let ftimer;
function filterTree(q){
  clearTimeout(ftimer);
  ftimer=setTimeout(()=>{
    if(!rezData)return;
    const tree=document.getElementById('rez-tree');
    if(!q.trim()){tree.innerHTML=buildHTML(rezData.root,0);bindClicks(tree);return;}
    function search(dir,q){
      let res=dir.files.filter(f=>f.name.toLowerCase().includes(q)||f.ext.toLowerCase().includes(q));
      for(const d of dir.dirs)res=res.concat(search(d,q));
      return res;
    }
    const matches=search(rezData.root,q.toLowerCase());
    const flat={name:'',path:'/',files:matches,dirs:[]};
    tree.innerHTML=buildHTML(flat,0);bindClicks(tree);
  },150);
}

function launchFromRez(){
  if(!rezData)return;
  toast(`ü¶Ö Full engine launch coming in v0.2 ‚Äî ${rezData.total} files indexed & ready!`,'info');
}
</script>
</body>
</html>
